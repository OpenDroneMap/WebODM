<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="utf-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
	<title>Potree Viewer</title>

	<!-- Styles -->
	<link rel="stylesheet" type="text/css" href="../build/potree/potree.css">
	<link rel="stylesheet" type="text/css" href="../libs/jquery-ui/jquery-ui.min.css">
	<link rel="stylesheet" type="text/css" href="../libs/openlayers3/ol.css">
	<link rel="stylesheet" type="text/css" href="../libs/spectrum/spectrum.css">
	<link rel="stylesheet" type="text/css" href="../libs/jstree/themes/mixed/style.css">
</head>

<body>
	<!-- Dependencies -->
	<script src="../libs/jquery/jquery-3.1.1.min.js"></script>
	<script src="../libs/spectrum/spectrum.js"></script>
	<script src="../libs/jquery-ui/jquery-ui.min.js"></script>
	<script src="../libs/other/BinaryHeap.js"></script>
	<script src="../libs/tween/tween.min.js"></script>
	<script src="../libs/d3/d3.js"></script>
	<script src="../libs/proj4/proj4.js"></script>
	<script src="../libs/openlayers3/ol.js"></script>
	<script src="../libs/i18next/i18next.js"></script>
	<script src="../libs/jstree/jstree.js"></script>
	<script src="../build/potree/potree.js"></script>
	<script src="../libs/plasio/js/laslaz.js"></script>

	<!-- Viewer container -->
	<div class="potree_container" style="position:absolute; width:100%; height:100%; left:0; top:0;">
		<div id="potree_render_area" style="background-image: url('../build/potree/resources/images/background.jpg');"></div>
		<div id="potree_sidebar_container"></div>
	</div>

	<script>
		// JWT Token
		const jwtToken = "eyJ0eXAiOiJKV1QiLCJhbGciOiJIUzI1NiJ9.eyJ1c2VyX2lkIjoyLCJlbWFpbCI6IiIsInVzZXJuYW1lIjoiYWRuYW5hbGFtZWVyIiwiZXhwIjoxNzU3NjczNzY3fQ.zoMdFFvY0jmDsQRPdbrK2IVrW4-kblHEyB0oQgtnoog";
		
		// Override fetch to include JWT token in all requests
		const originalFetch = window.fetch;
		window.fetch = function(...args) {
			let [url, options] = args;
			
			if (typeof url === 'string' && url.includes('192.168.1.5:8000')) {
				options = options || {};
				options.headers = options.headers || {};
				options.headers['Authorization'] = `JWT ${jwtToken}`;
			}
			
			return originalFetch.call(this, url, options);
		};
		
		// Create viewer
		window.viewer = new Potree.Viewer(document.getElementById("potree_render_area"));

		viewer.setEDLEnabled(true);
		viewer.setFOV(60);
		viewer.setPointBudget(2_000_000);
		viewer.loadSettingsFromURL();
		viewer.setBackground("skybox");

		// Load sidebar
		viewer.loadGUI(() => {
			viewer.setLanguage('en');
			$("#menu_tools").next().show();
			$("#menu_clipping").next().show();
			viewer.toggleSidebar();
		});

		// Load your EPT point cloud
		Potree.loadPointCloud(
			"http://192.168.1.5:8000/api/projects/19/tasks/5e0520bb-3f18-455f-9d24-68b48e070026/assets/entwine_pointcloud/ept.json",
			"MyEPTCloud",
			e => {
				let scene = viewer.scene;
				let pointcloud = e.pointcloud;

				let material = pointcloud.material;
				material.size = 1;
				material.pointSizeType = Potree.PointSizeType.ADAPTIVE;
				material.shape = Potree.PointShape.SQUARE;

				scene.addPointCloud(pointcloud);
				viewer.fitToScreen();
			}
		);
	</script>
</body>
</html>